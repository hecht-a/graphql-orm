{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{# ================= TOOLBAR ================= #}

{% block toolbar %}
    {% set icon %}
        {{ source('@GraphqlOrm/collector/icon.svg') }}
        <span class="sf-toolbar-value">
            {{ collector.queryCount }}
        </span>
    {% endset %}

    {% set text %}
        <div class="sf-toolbar-info-piece">
            <b>Queries</b>
            <span class="sf-toolbar-status sf-toolbar-status-">{{ collector.queryCount }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Errors</b>
            <span class="sf-toolbar-status sf-toolbar-status-red">{{ collector.errorCount|default(0) }}</span>
        </div>
    {% endset %}

    {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', {
        link: profiler_url,
        icon: icon,
        text: text,
        status: collector.errorCount > 0 ? 'red'
    }) }}

{% endblock %}

{# ================= MENU ================= #}

{% block menu %}
    <span class="label {% if collector.errorCount > 0 %}label-status-error{% endif %}">
    <span class="icon">
        {{ source('@GraphqlOrm/collector/icon.svg') }}
    </span>

    <strong>GraphQL ORM</strong>
    {% if collector.queryCount > 0 %}
    <span class="count">
        <span>{{ collector.queryCount }}</span>
    </span>
    {% endif %}
</span>
{% endblock %}

{# ================= PANEL ================= #}

{% block panel %}
    <h2>GraphQL ORM Queries</h2>
    {% if collector.queryCount == 0 %}
        <div class="empty">
            <p>No GraphQL queries were executed.</p>
        </div>
    {% else %}
        {% for query in collector.queries %}
            <div class="sf-profiler-block">
                <h3>
                    Query #{{ loop.index }}
                    {% if query.errors %}
                        <span style="
                            background:#ff6b6b;
                            color:white;
                            padding:2px 6px;
                            border-radius:4px;
                            font-size:12px;
                            margin-left:6px;
                            ">
                            ERROR
                        </span>
                    {% endif %}
                </h3>
                <table>
                    <tbody>
                    <tr>
                        <th style="width:150px">Endpoint</th>
                        <td>{{ query.endpoint }}</td>
                    </tr>
                    <tr>
                        <th>Response size</th>
                        <td>{{ query.response_size }} bytes</td>
                    </tr>
                    <tr>
                        <th>GraphQL Depth</th>
                        <td>{{ query.depth_used }}</td>
                    </tr>
                    </tbody>
                </table>

                {% if query.errors %}
                    <h4 style="color: #ff6b6b">GraphQL Errors</h4>

                    {% for error in query.errors %}
                        <div style="
                            background: #2a1416;
                            border-left: 4px solid #ff6b6b;
                            padding: 10px;
                            margin-bottom: 10px;
                            border-radius: 6px;
                            ">
                            <strong>{{ error.message }}</strong>

                            {% if error.extensions.code ?? null %}
                                <br>
                                <small>Code : {{ error.extensions.code }}</small>
                            {% endif %}

                            {% if error.extensions.exception.stacktrace ?? null %}
                                <details style="margin-top: 8px">
                                    <summary style="cursor: pointer">
                                        Stacktrace
                                    </summary>
                                    <pre style="
                                        max-height: 250px;
                                        overflow: auto;
                                        background: #18171b;
                                        padding: 10px;
                                        border-radius: 6px;
                                        ">
{{ error.extensions.exception.stacktrace|join("\n") }}
                                    </pre>
                                </details>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}

                <h4>Hydration</h4>
                <table {% if query.errors %}style="opacity: .5"{% endif %}>
                    <tbody>
                    <tr>
                        <th style="width:200px">Entities</th>
                        <td>{{ query.hydrated_entities }}</td>
                    </tr>
                    <tr>
                        <th>Relations</th>
                        <td>{{ query.hydrated_relations }}</td>
                    </tr>
                    <tr>
                        <th>Collections</th>
                        <td>{{ query.hydrated_collections }}</td>
                    </tr>
                    <tr>
                        <th>Root result count</th>
                        <td>{{ query.hydrated_count }}</td>
                    </tr>
                    </tbody>
                </table>

                <h4>GraphQL Query</h4>
                <div style="position:relative">
                    <button
                            class="sf-toolbar-reset"
                            style="
position:absolute;
right:8px;
top:8px;
cursor:pointer;
font-size:12px;
padding:4px 8px;
border-radius:4px;
border:1px solid #444;
background:#2d2d2d;
color:white;
" onclick="copyGraphql(this)" data-graphql="{{ query.graphql|e('html_attr') }}">
                        Copy
                    </button>
                    <pre style="
white-space:pre-wrap;
overflow:auto;
max-height:300px;
background:#18171b;
color:#d7dae0;
padding:10px;
border-radius:6px;
">
{{ query.graphql }}
</pre>
                </div>

                {% if query.ast %}
                    <h4>GraphQL AST</h4>
                    <div class="graphql-ast-tree">
                        {{ _self.renderAst(query.ast, 0) }}
                    </div>
                {% endif %}

                <h4>Variables</h4>
                {% if query.variables %}
                    <pre>{{ dump(query.variables) }}</pre>
                {% else %}
                    <p>—</p>
                {% endif %}
                <h4>Caller</h4>
                {% if query.caller %}
                    <p>
                        <strong>
                            {{ query.caller.file|split('/')|last }}:{{ query.caller.line }}
                        </strong>
                        <br>
                        {{ query.caller.class }}::{{ query.caller.function }}()
                        <br>
                        <small style="color:#666">
                            {{ query.caller.file }}
                        </small>
                    </p>
                {% endif %}
                <hr>
            </div>
        {% endfor %}
    {% endif %}

    {% macro renderAst(node, depth) %}
        {% import _self as self %}
        {% if node.operation is defined %}
            <div class="ast-node ast-root">
                <div class="ast-header open">
                    <span class="ast-toggle">▼</span>
                    <strong>{{ node.operation }}</strong>
                    <span class="ast-meta">
                        [depth: {{ depth }} | fields: {{ node.fields|length }}]
                    </span>
                </div>
                <div class="ast-children">
                    {% for field in node.fields %}
                        {{ self.renderAst(field, depth + 1) }}
                    {% endfor %}
                </div>
            </div>
        {% else %}
            {% set hasChildren = node.selectionSet and node.selectionSet.fields|length > 0 %}
            <div class="ast-node">
                <div class="ast-header {{ hasChildren ? 'open' : '' }}">
                    {% if hasChildren %}
                        <span class="ast-toggle">▼</span>
                    {% else %}
                        <span class="ast-leaf">•</span>
                    {% endif %}
                    <span class="ast-name">
                        {{ node.name }}
                        {% if node.arguments is defined and node.arguments %}
                            (
                            {% for k,v in node.arguments %}
                                {{ k }}={{ v }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            )
                        {% endif %}
                    </span>
                    {% if hasChildren %}
                        <span class="ast-meta">
                            [depth: {{ depth }} | fields: {{ node.selectionSet.fields|length }}]
                        </span>
                    {% endif %}
                </div>
                {% if hasChildren %}
                    <div class="ast-children">
                        {% for child in node.selectionSet.fields %}
                            {{ self.renderAst(child,depth + 1) }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    {% endmacro %}

    <style>
        .graphql-ast-tree{
            font-family:monospace;
            background:#18171b;
            padding:12px;
            border-radius:6px;
        }

        .ast-node{
            margin-left:12px;
        }

        .ast-header{
            cursor:pointer;
            padding:2px 6px;
            border-radius:4px;
            display:flex;
            gap:8px;
            align-items:center;
        }

        .ast-header:hover{
            background:#2d2d2d;
            outline:1px solid #4b4b4b;
        }

        .ast-toggle{
            width:14px;
            display:inline-block;
            user-select:none;
        }

        .ast-leaf{
            width:14px;
            opacity:.4;
        }

        .ast-meta{
            color:#888;
            font-size:11px;
            margin-left:auto;
        }

        .ast-name{
            color:#9cdcfe;
        }

        .ast-children{
            margin-left:18px;
            border-left:1px solid #333;
            padding-left:10px;
        }

        .ast-node.collapsed > .ast-children{
            display:none;
        }
    </style>

    <script>
        function copyGraphql(button) {
            const query = button.dataset.graphql;
            navigator.clipboard.writeText(query)
                .then(() => {
                    const original = button.innerText;
                    button.innerText = "Copied ✓";
                    setTimeout(() => {
                        button.innerText = original;
                    }, 1200);
                });
        }

        document.addEventListener("click", (e) => {
            const header = e.target.closest(".ast-header")

            if (!header) {
                return
            }

            const node = header.parentElement

            const children = node.querySelector(":scope > .ast-children")

            if (!children) {
                return
            }
            node.classList.toggle("collapsed")

            const toggle = header.querySelector(".ast-toggle")

            if (toggle) {
                toggle.innerText = node.classList.contains("collapsed") ? "▶" : "▼"
            }
        })
    </script>
{% endblock %}